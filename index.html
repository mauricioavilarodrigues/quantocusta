<script>
let nichoAtual="",tipoAtual="",categoriaAtual="",categoriaFarmaciaAtual="";
let cesta={};

// pegar filtros
const filtroSupermercado = document.getElementById("filtroSupermercado");
const filtroCombustivel = document.getElementById("filtroCombustivel");
const filtroFarmacia = document.getElementById("filtroFarmacia");

// limpar botões ativos
function limparAtivos(grupo){document.querySelectorAll(grupo+" button").forEach(b=>b.classList.remove("ativo"));}

// seleção de nicho e filtros
function setNicho(n,b){
    nichoAtual=n;tipoAtual="";categoriaAtual="";categoriaFarmaciaAtual="";
    document.getElementById("resultado").innerHTML="";
    limparAtivos(".topo"); b.classList.add("ativo");
    filtroSupermercado.style.display = "none";
    filtroCombustivel.style.display = "none";
    filtroFarmacia.style.display = "none";
    if(n=="supermercado") filtroSupermercado.style.display="flex";
    if(n=="combustivel") filtroCombustivel.style.display="flex";
    if(n=="farmacia") filtroFarmacia.style.display="flex";
}

function setTipo(t,b){tipoAtual=t;limparAtivos("#filtroCombustivel");b.classList.add("ativo");buscar();}
function setCategoria(c,b){categoriaAtual=c;limparAtivos("#filtroSupermercado");b.classList.add("ativo");buscar();}
function setCategoriaFarmacia(c,b){categoriaFarmaciaAtual=c;limparAtivos("#filtroFarmacia");b.classList.add("ativo");buscar();}

// buscar produtos
async function buscar(){
    if(!nichoAtual) return;
    if(nichoAtual=="combustivel" && !tipoAtual) return;
    if(nichoAtual=="supermercado" && !categoriaAtual) return;
    if(nichoAtual=="farmacia" && !categoriaFarmaciaAtual) return;

    const termo = document.getElementById("busca").value.toLowerCase();
    const cidadeFiltro = document.getElementById("cidade").value.toLowerCase();

    try {
        const res = await fetch("data.json");
        const data = await res.json();
        let itens = data[nichoAtual].filter(p => {
            let ok = true;
            if(termo && !p.nome.toLowerCase().includes(termo)) ok=false;
            if(nichoAtual=="combustivel" && tipoAtual && !p.nome.includes(tipoAtual)) ok=false;
            if(nichoAtual=="supermercado" && categoriaAtual && p.tipo!=categoriaAtual) ok=false;
            if(nichoAtual=="farmacia" && categoriaFarmaciaAtual && p.tipo!=categoriaFarmaciaAtual) ok=false;
            if(cidadeFiltro && !p.cidade.toLowerCase().includes(cidadeFiltro)) ok=false;
            return ok;
        });
        mostrarResultados(itens);
    } catch(err){
        console.error("Erro ao buscar produtos:", err);
    }
}

// mostrar produtos
function mostrarResultados(itens){
    const resultado = document.getElementById("resultado");
    resultado.innerHTML="";
    itens.forEach(p=>{
        const li = document.createElement("li");
        li.innerHTML = `<span>
            <input type="number" min="0" value="${cesta[p.id]?.quantidade || 0}" class="quantidade" onchange='atualizarCesta(${p.id}, this.value)'>
            ${p.nome}<br><small>${p.loja || p.posto} - ${p.cidade}</small>
        </span>
        <span class="preco">R$ ${p.preco.toFixed(2)}</span>`;
        resultado.appendChild(li);
    });
}

// atualizar cesta
function atualizarCesta(id, q){
    q = parseInt(q);
    fetch("data.json")
    .then(res => res.json())
    .then(data=>{
        let allProducts = [...data.supermercado, ...data.combustivel, ...data.farmacia];
        let p = allProducts.find(x => x.id === id);
        if(!p) return;
        if(q>0) cesta[id] = {produto: p, quantidade: q};
        else delete cesta[id];
        mostrarCesta();
    });
}

// mostrar cesta
function mostrarCesta(){
    const lista = document.getElementById("cestaLista");
    lista.innerHTML="";
    for(let k in cesta){
        let item = cesta[k];
        let li = document.createElement("li");
        li.innerText = `${item.produto.nome} x${item.quantidade} - R$ ${(item.produto.preco*item.quantidade).toFixed(2)}`;
        lista.appendChild(li);
    }
}

// comparar cesta
function compararCesta(){
    let porLoja={};
    for(let k in cesta){
        let item=cesta[k];
        let l=item.produto.loja||item.produto.posto;
        porLoja[l]=(porLoja[l]||0)+(item.produto.preco*item.quantidade);
    }
    let html="<h3>Resultado da cesta</h3>";
    let menor=Infinity;
    for(let l in porLoja) menor=Math.min(menor,porLoja[l]);
    for(let l in porLoja){
        let cls=porLoja[l]==menor?"menor":"";
        html+=`<div class="${cls}">${l}: R$ ${porLoja[l].toFixed(2)}</div>`;
    }
    document.getElementById("cestaResultado").innerHTML = html;
}
</script>
