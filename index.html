<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Quantocusta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <h1>ğŸ’° Quantocusta</h1>

  <!-- Seletor de nichos -->
  <div class="topo">
    <button onclick="setNicho('supermercado',this)">ğŸ›’ Supermercado</button>
    <button onclick="setNicho('combustivel',this)">â›½ CombustÃ­vel</button>
    <button onclick="setNicho('farmacia',this)">ğŸ’Š FarmÃ¡cia</button>
  </div>

  <!-- Filtros -->
  <div id="filtroSupermercado" class="filtros" style="display:none;">
    <button onclick="setCategoria('alimento',this)">ğŸ¥¦ Alimentos</button>
    <button onclick="setCategoria('limpeza',this)">ğŸ§¼ Limpeza</button>
  </div>

  <div id="filtroCombustivel" class="filtros" style="display:none;">
    <button onclick="setTipo('gasolina',this)">â›½ Gasolina</button>
    <button onclick="setTipo('etanol',this)">ğŸŒ¿ Etanol</button>
    <button onclick="setTipo('diesel',this)">ğŸšš Diesel</button>
  </div>

  <div id="filtroFarmacia" class="filtros" style="display:none;">
    <button onclick="setCategoriaFarmacia('medicamento',this)">ğŸ’Š Medicamentos</button>
    <button onclick="setCategoriaFarmacia('higiene',this)">ğŸ§´ Higiene</button>
  </div>

  <!-- Busca -->
  <div class="busca">
    <form onsubmit="buscar(); return false;">
      <input id="busca" placeholder="Buscar...">
      <button type="submit">Buscar</button>
    </form>
  </div>

  <!-- Resultados -->
  <ul id="resultado"></ul>

  <!-- AÃ§Ãµes -->
  <div class="caixa">
    <button onclick="compararCesta()">ğŸ§º Comparar cesta</button>
    <div id="cestaResultado"></div>
  </div>

  <div class="caixa">
    <button onclick="acharMelhorOpcao()">ğŸ“ Melhor opÃ§Ã£o perto de vocÃª</button>
  </div>

  <!-- Mapa dentro do quadro -->
  <div class="caixa">
    <h3>Mapa de LocalizaÃ§Ã£o</h3>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS (sempre antes do seu script que usa L.*) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===== VARIÃVEIS =====
    let nichoAtual = "", tipoAtual = "", categoriaAtual = "", categoriaFarmaciaAtual = "";
    let cesta = [], markersLayer, usuarioPosicao = null, pontos = [];

    // ===== CONTROLES =====
    function limparAtivos(grupo){
      document.querySelectorAll(grupo + " button").forEach(b => b.classList.remove("ativo"));
    }

    function setNicho(n, b){
      nichoAtual = n;
      tipoAtual = "";
      categoriaAtual = "";
      categoriaFarmaciaAtual = "";
      document.getElementById("resultado").innerHTML = "";

      limparAtivos(".topo");
      b.classList.add("ativo");

      ["Supermercado","Combustivel","Farmacia"].forEach(f => {
        document.getElementById("filtro" + f).style.display = "none";
      });

      if(n === "supermercado") document.getElementById("filtroSupermercado").style.display = "flex";
      if(n === "combustivel") document.getElementById("filtroCombustivel").style.display = "flex";
      if(n === "farmacia") document.getElementById("filtroFarmacia").style.display = "flex";
    }

    function setTipo(t, b){
      tipoAtual = t;
      limparAtivos("#filtroCombustivel");
      b.classList.add("ativo");
      buscar();
    }

    function setCategoria(c, b){
      categoriaAtual = c;
      limparAtivos("#filtroSupermercado");
      b.classList.add("ativo");
      buscar();
    }

    function setCategoriaFarmacia(c, b){
      categoriaFarmaciaAtual = c;
      limparAtivos("#filtroFarmacia");
      b.classList.add("ativo");
      buscar();
    }

    // ===== BUSCA =====
    async function buscar(){
      if(!nichoAtual) return alert("Selecione um nicho.");
      if(nichoAtual === "combustivel" && !tipoAtual) return alert("Selecione o tipo.");
      if(nichoAtual === "supermercado" && !categoriaAtual) return alert("Selecione a categoria.");
      if(nichoAtual === "farmacia" && !categoriaFarmaciaAtual) return alert("Selecione a categoria.");

      const termo = (document.getElementById("busca").value || "").toLowerCase();

      const res = await fetch("data.json");
      const data = await res.json();

      let itens = (data[nichoAtual] || []).filter(p => (p.nome || "").toLowerCase().includes(termo));

      if(nichoAtual === "combustivel") itens = itens.filter(p => (p.nome || "").toLowerCase().includes(tipoAtual.toLowerCase()));
      if(nichoAtual === "supermercado") itens = itens.filter(p => p.tipo === categoriaAtual);
      if(nichoAtual === "farmacia") itens = itens.filter(p => p.tipo === categoriaFarmaciaAtual);

      const resultado = document.getElementById("resultado");
      resultado.innerHTML = "";

      itens.forEach((p, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>
            <input type="checkbox" onchange='addCesta(${JSON.stringify(p)})'>
            ${p.nome}<br><small>${p.loja || p.posto || ""}</small>
          </span>
          <span class="preco">R$ ${Number(p.preco).toFixed(2)}</span>
          <div class="avaliacao">
            <strong>Este preÃ§o confere?</strong><br>
            <button onclick="confirmarPreco(${index})">ğŸ‘ Confere</button>
            <button onclick="negarPreco(${index})">âŒ NÃ£o confere</button>
            <div id="feedback-${index}"></div>
          </div>
        `;
        resultado.appendChild(li);
      });
    }

    // ===== CESTA =====
    function addCesta(p){ cesta.push(p); }

    function compararCesta(){
      let porLoja = {};
      cesta.forEach(p => {
        let l = p.loja || p.posto || "Sem nome";
        porLoja[l] = (porLoja[l] || 0) + Number(p.preco || 0);
      });

      let html = "<h3>Resultado da cesta</h3>";
      let menor = Infinity;

      for(let l in porLoja) menor = Math.min(menor, porLoja[l]);

      for(let l in porLoja){
        let cls = porLoja[l] === menor ? "menor" : "";
        html += `<div class="${cls}">${l}: R$ ${porLoja[l].toFixed(2)}</div>`;
      }

      document.getElementById("cestaResultado").innerHTML = html;
    }

    // ===== MAPA =====
    const map = L.map("map").setView([-32.035, -52.098], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap"
    }).addTo(map);

    markersLayer = L.layerGroup().addTo(map);

    // Marcador do usuÃ¡rio
    map.locate({ setView:true, maxZoom:15 });
    map.on("locationfound", e => {
      usuarioPosicao = e.latlng;
      L.circleMarker(usuarioPosicao, {
        radius: 8,
        color: "#4f5dff",
        fillColor: "#4f5dff",
        fillOpacity: 0.8
      }).addTo(map).bindPopup("<b>VocÃª estÃ¡ aqui</b>").openPopup();
    });

    // Coordenadas fictÃ­cias (mantive como estava)
    const coords = {
      "Buffon": [-32.035, -52.095],
      "SIM":    [-32.032, -52.105],
      "Shell":  [-32.040, -52.090]
    };

    async function carregarMapa(){
      const res = await fetch("data.json");
      const data = await res.json();

      markersLayer.clearLayers();
      pontos = [];

      (data.combustivel || []).forEach(p => {
        const c = coords[p.posto];
        if(!c) return;

        const marker = L.marker(c).addTo(markersLayer);
        marker.bindPopup(
          `<b style="color:#4f5dff;">${p.posto}</b><br>${p.nome}<br>R$ ${Number(p.preco).toFixed(2)}`
        );

        pontos.push({ lat: c[0], lng: c[1], nome: p.posto, preco: Number(p.preco), marker });
      });
    }

    carregarMapa();

    function distancia(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function acharMelhorOpcao(){
      if(!usuarioPosicao) return alert("LocalizaÃ§Ã£o nÃ£o encontrada.");

      const pesoDistancia = 2;

      pontos.forEach(p => {
        p.distancia = distancia(usuarioPosicao.lat, usuarioPosicao.lng, p.lat, p.lng);
        p.score = p.preco + (p.distancia * pesoDistancia);
      });

      pontos.sort((a,b) => a.score - b.score);

      const melhor = pontos[0];
      if(!melhor) return alert("NÃ£o hÃ¡ pontos carregados no mapa.");

      melhor.marker.openPopup();
      map.setView([melhor.lat, melhor.lng], 16);

      alert(
        `ğŸ† Melhor opÃ§Ã£o:\n\n${melhor.nome}\nPreÃ§o: R$ ${melhor.preco.toFixed(2)}\nDistÃ¢ncia: ${melhor.distancia.toFixed(2)} km\nScore: ${melhor.score.toFixed(2)}`
      );
    }

    function confirmarPreco(index){
      document.getElementById(`feedback-${index}`).innerText = "Obrigado por confirmar o preÃ§o ğŸ‘";
    }

    function negarPreco(index){
      document.getElementById(`feedback-${index}`).innerText = "PreÃ§o contestado. Obrigado pela colaboraÃ§Ã£o âŒ";
    }
  </script>

  <!-- Se vocÃª tiver um script.js, ele vem aqui, fora do script acima -->
  <script src="script.js"></script>
</body>
</html>
